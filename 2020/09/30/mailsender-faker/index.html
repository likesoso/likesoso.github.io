<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>
        likesoso - 随便写写
    </title>
    
<link rel="stylesheet" href="/libs/highlight/styles/monokai-sublime.css">

    
<link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.1.1"></head>

<body id="bodyx">
    <div class="hd posts">
    <a href="/index.html"><i class="fa fa-reply replay-btn" aria-hidden="true"></i></a>
    <div class="post-title">
        <p>
            mailsender_faker
        </p>
        <hr>
    </div>
    <div class="post-content">
        <h1 id="社工-邮件伪造"><a href="#社工-邮件伪造" class="headerlink" title="社工-邮件伪造"></a>社工-邮件伪造</h1><h2 id="SMTP协议的原理及漏洞"><a href="#SMTP协议的原理及漏洞" class="headerlink" title="SMTP协议的原理及漏洞"></a>SMTP协议的原理及漏洞</h2><p>SMTP协议基于TCP，是一种提供可靠且有效的电子邮件传输协议。是建立在FTP文件传输服务上的一种邮件服务。主要有三个工作过程，我们使用swaks来逐步分析：</p>
<p>1.建立连接：SMTP客户端请求与服务端建立一个TCP的连接，互相通告自己的域名，同时确认对方的域名。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;&#x3D;&#x3D; Trying mx.test.com:25...</span><br><span class="line">&#x3D;&#x3D;&#x3D; Connected to mx.test.com.</span><br><span class="line">&lt;-  220 ESMTP IMSVA	</span><br></pre></td></tr></table></figure>

<p>2.传输数据：利用命令，SMTP客户端将邮件的原地址，目的地址和邮件的具体内容传递给SMTP服务器，服务器进行响应并接受邮件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"> -&gt; EHLO likesoso.com</span><br><span class="line">&lt;-  250-imsva02.ais.com</span><br><span class="line">&lt;-  250-PIPELINING</span><br><span class="line">&lt;-  250-SIZE 125829120</span><br><span class="line">&lt;-  250-ETRN</span><br><span class="line">&lt;-  250-STARTTLS</span><br><span class="line">&lt;-  250-ENHANCEDSTATUSCODES</span><br><span class="line">&lt;-  250-8BITMIME</span><br><span class="line">&lt;-  250 DSN</span><br><span class="line"> -&gt; MAIL FROM:&lt;likesoso@likesoso.com&gt;</span><br><span class="line">&lt;-  250 2.1.0 Ok</span><br><span class="line"> -&gt; RCPT TO:&lt;test@test.com&gt;</span><br><span class="line">&lt;-  250 2.1.5 Ok</span><br><span class="line"> -&gt; DATA</span><br><span class="line">&lt;-  354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;</span><br><span class="line"> -&gt; Date: Wed, 30 Sep 2020 14:30:59 +0800</span><br><span class="line"> -&gt; To:test@test.com</span><br><span class="line"> -&gt; From: likesoso@likesoso.com</span><br><span class="line"> -&gt; Subject: test Wed, 30 Sep 2020 14:30:59 +0800</span><br><span class="line"> -&gt; Message-Id: &lt;20200930143059.029941@likesoso.com&gt;</span><br><span class="line"> -&gt; X-Mailer: swaks v20190914.0 jetmore.org&#x2F;john&#x2F;code&#x2F;swaks&#x2F;</span><br><span class="line"> -&gt; </span><br><span class="line"> -&gt; This is a test mailing</span><br><span class="line"> -&gt; </span><br><span class="line"> -&gt; </span><br><span class="line"> -&gt; .</span><br><span class="line">&lt;-  250 2.0.0 Ok: queued as 8B353C073</span><br></pre></td></tr></table></figure>

<p>3.释放连接：SMTP客户端发出命令，服务端接收后，关闭TCP连接。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> -&gt; QUIT</span><br><span class="line">&lt;-  221 2.0.0 Bye</span><br><span class="line">&#x3D;&#x3D;&#x3D; Connection closed with remote host.</span><br></pre></td></tr></table></figure>


<p>在传输数据的过程中不难发现，有两个from字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MAIL FROM:&lt;likesoso@likesoso.com&gt;</span><br><span class="line">From: likesoso@likesoso.com</span><br></pre></td></tr></table></figure>
<p>MAIL FROM在SMTP认证中表示邮件的发送者，FROM代表邮件内容中展示出来的发件人地址。</p>
<p><img src="/2020/09/30/mailsender-faker/1-1.jpg"></p>
<p>简单来说就是MAIL FROM是给SMTP服务器看的发件人地址，FROM是给收件人看的发件人地址。而这两个地址都是发件人可控的，服务器并没有对地址进行校验。由此攻击者可以构造MAIL FROM、达到欺骗的效果。</p>
<p><img src="/2020/09/30/mailsender-faker/1-2.jpg"></p>
<h2 id="预防方法"><a href="#预防方法" class="headerlink" title="预防方法"></a>预防方法</h2><h3 id="SPF"><a href="#SPF" class="headerlink" title="SPF"></a>SPF</h3><p>Sender Policy Framework，是一种以IP地址认证电子邮件发件人身份的技术。邮件接收方首先会去检查域名的SPF记录，来确定发件人的IP地址是否被包含在SPF记录里面，如果在，就认为是一封正确的邮件，否则会认为是一封伪造的邮件并进行退回。</p>
<p>可以看到huawei.com具备一个SPF解析记录指向 <em>v=spf1 ip4:45.249.212.32 ip4:45.249.212.35 ip4:45.249.212.255 ip4:45.249.212.187/29 ip4:45.249.212.191 ip4:185.176.76.210 ip4:168.195.93.47 ip4:103.69.140.247 -all</em></p>
<p><img src="/2020/09/30/mailsender-faker/1-3.jpg"></p>
<p>假设b.com的服务器收到了一封邮件，发送的主机是1.2.3.4，并且声称自己的MAIL FROM字段为<a href="mailto:&#x73;&#64;&#97;&#46;&#99;&#x6f;&#109;">&#x73;&#64;&#97;&#46;&#99;&#x6f;&#109;</a>。为了确认发件人是否是伪造的，邮件服务器b.com会去请求DNS服务器查询a.com的SPF记录。</p>
<p>如果：</p>
<p>a.com不存在SPF记录：则表明可以任意伪造<br>a.com存在SPF记录，且记录为1.2.3.4：邮件合法<br>a.com存在SPF记录，且记录不为1.2.3.4：进垃圾箱、显示由另一个ip代发</p>
<p><img src="/2020/09/30/mailsender-faker/1-4.jpg"></p>
<p>简单来说就是b.com服务器收信后，根据SPF记录来确定这封信的真实来源，是否跟MAIL FROM中申明的发件人的ip地址一致。</p>

    </div>

    
</div>
    <div class="footer" id="footer">
    <p>Copyright © 2020 <a class="flink" target="_blank" rel="noopener" href="https://hexo.io">Hexo</a>-<a class="flink" target="_blank" rel="noopener" href="https://github.com/sanjinhub/hexo-theme-geek">Geek</a>.
        <label class="el-switch el-switch-green el-switch-sm" style="vertical-align: sub;">
            <input type="checkbox" name="switch" id="update_style">
            <span class="el-switch-style"></span>
        </label>
<!--         <script type="text/javascript">
        var cnzz_protocol = (("https:" == document.location.protocol) ? "https://" : "http://");
        document.write(unescape("%3Cspan id='cnzz_stat_icon_1278548644'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "v1.cnzz.com/stat.php%3Fid%3D1278548644%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
        </script> -->
    </p>
</div>
<input type="hidden" id="web_style" value="black">
<input type="hidden" id="valine_appid" value="CmCti21ooOOIzFOhEyFkFvR0-gzGzoHsz">
<input type="hidden" id="valine_appKey" value="FqiyUqbg7McKN2eG0MCewupf">

<script src="/libs/jquery.min.js"></script>


<script src="/libs/highlight/highlight.pack.js"></script>

<script src='//cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js'></script>

<script src="/js/js.js"></script>

<style type="text/css">
.v * {
    color: #698fca;
}

.v .vlist .vcard .vhead .vsys {
    color: #3a3e4a;
}

.v .vlist .vcard .vh .vmeta .vat {
    color: #638fd5;
}

.v .vlist .vcard .vhead .vnick {
    color: #6ba1ff;
}

.v a {
    color: #8696b1;
}

.v .vlist .vcard .vhead .vnick:hover {
    color: #669bfc;
}
</style>
</body>

</html>